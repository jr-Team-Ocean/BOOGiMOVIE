<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bm.project.chatting.model.dao.ChattingMapper">
	
	<resultMap type="com.bm.project.chatting.model.dto.Member_C" id="member_rm">
		<id property="memberNo" column="MEMBER_NO" />
		<result property="profilePath" column="PROFILE_PATH"/>
		<result property="memberEmail" column="MEMBER_EMAIL"/>
		<result property="memberNickname" column="MEMBER_NICKNAME"/>
	</resultMap>
	
	<resultMap type="com.bm.project.chatting.model.dto.ChattingMessage" id="message_rm">
	     <id property="messageId" column="MESSAGE_ID" />
	     <result property="messageContent" column="MESSAGE_CONTENT" />
	     <result property="sentAt" column="SENT_AT" />
	     <result property="chattingRoomId" column="CHATTING_ROOM_ID" />
	     <result property="readYn" column="READ_YN" />
	     <result property="senderId" column="SENDER_ID" />
	</resultMap>
	
	<resultMap type="com.bm.project.chatting.model.dto.ChattingImage" id="image_rm">
	     <id property="chattingImageNo" column="CHATTING_IMAGE_NO" />
	     <result property="messageId" column="MESSAGE_ID" />
	     <result property="chattingImagePath" column="CHATTING_IMAGE_PATH" />	     
	</resultMap>	

	<resultMap type="com.bm.project.chatting.model.dto.ChattingRoom" id="chattingRoom_rm">
	    <id property="chattingRoomId" column="CHATTING_ROOM_ID" />
	    <result property="targetNo" column="TARGET_NO"/>
	    <result property="targetNickName" column="TARGET_NICKNAME"/> <result property="targetProfile" column="TARGET_PROFILE"/>
	    <result property="lastMessage" column="LAST_MESSAGE"/>
	    <result property="sendTime" column="SEND_TIME"/>
	    <result property="notReadCount" column="NOT_READ_COUNT"/>
	</resultMap>

	<select id="selectRoomList" resultMap="chattingRoom_rm">
    SELECT 
        R.CHATTING_ROOM_ID, 
        (SELECT MESSAGE_CONTENT FROM (
            SELECT M.MESSAGE_CONTENT FROM CHATTING_MESSAGE M
            WHERE M.CHATTING_ROOM_ID = R.CHATTING_ROOM_ID
            ORDER BY M.MESSAGE_ID DESC) 
            WHERE ROWNUM = 1
        ) AS LAST_MESSAGE, 
        (SELECT TO_CHAR(MAX(SENT_AT), 'YYYY.MM.DD') 
         FROM CHATTING_MESSAGE M
         WHERE M.CHATTING_ROOM_ID = R.CHATTING_ROOM_ID) AS SEND_TIME,
        
        CASE 
            WHEN ADMIN_MEMBER_NO = #{loginMemberNo} THEN USER_MEMBER_NO
            ELSE ADMIN_MEMBER_NO
        END AS TARGET_NO,
        
        (SELECT MEMBER_NICKNAME FROM MEMBER 
         WHERE MEMBER_NO = (CASE WHEN ADMIN_MEMBER_NO = #{loginMemberNo} THEN USER_MEMBER_NO ELSE ADMIN_MEMBER_NO END)
        ) AS TARGET_NICKNAME,
        
        (SELECT PROFILE_PATH FROM MEMBER 
         WHERE MEMBER_NO = (CASE WHEN ADMIN_MEMBER_NO = #{loginMemberNo} THEN USER_MEMBER_NO ELSE ADMIN_MEMBER_NO END)
        ) AS TARGET_PROFILE,
        
        (SELECT COUNT(*) FROM CHATTING_MESSAGE M
         WHERE READ_YN = 'N'
         AND M.CHATTING_ROOM_ID = R.CHATTING_ROOM_ID
         AND SENDER_ID != #{loginMemberNo}) AS NOT_READ_COUNT
     
	    FROM CHATTING_ROOM R
	    WHERE ADMIN_MEMBER_NO = #{loginMemberNo}
	    OR USER_MEMBER_NO = #{loginMemberNo}
	    ORDER BY CHATTING_ROOM_ID DESC 
	</select>

	<select id="selectTarget" resultMap="member_rm">
		SELECT MEMBER_NO, PROFILE_PATH, MEMBER_NICKNAME, MEMBER_EMAIL
		FROM MEMBER
		WHERE (MEMBER_EMAIL LIKE '%${query}%' OR MEMBER_NICKNAME LIKE '%${query}%')
		AND SECESSION_FL = 'N'
		AND MEMBER_NO != #{memberNo}
	</select>
	
	<select id="checkChattingNo" resultType="_int">
		SELECT NVL(MAX(CHATTING_ROOM_ID), 0) FROM CHATTING_ROOM
		WHERE (ADMIN_MEMBER_NO = #{targetNo} AND USER_MEMBER_NO = #{loginMemberNo})
		OR (ADMIN_MEMBER_NO = #{loginMemberNo} AND USER_MEMBER_NO = #{targetNo})
	</select>
	
	<insert id="createChattingRoom" parameterType="map" useGeneratedKeys="true">
    	<selectKey order="BEFORE" resultType="_int" keyProperty="chattingNo">
        	SELECT SEQ_ROOM_NO.NEXTVAL FROM DUAL
    	</selectKey>

    	INSERT INTO CHATTING_ROOM
   		VALUES(#{chattingNo}, DEFAULT, #{loginMemberNo}, #{targetNo})
	</insert>
	
	<update id="updateReadFlag">
		UPDATE CHATTING_MESSAGE SET
		READ_YN = 'Y'
		WHERE CHATTING_ROOM_ID = #{chattingNo}
		AND SENDER_ID != #{memberNo}
	</update>
	
	<select id="selectMessageList" resultMap="message_rm">
	    SELECT MESSAGE_ID, MESSAGE_CONTENT, READ_YN, 
	        TO_CHAR(SENT_AT, 'YYYY.MM.DD HH24:MI') SENT_AT, SENDER_ID, CHATTING_ROOM_ID
	    FROM CHATTING_MESSAGE
	    WHERE CHATTING_ROOM_ID = #{chattingNo} ORDER BY MESSAGE_ID
	</select>
	
	<insert id="insertMessage">
	    INSERT INTO CHATTING_MESSAGE
	    VALUES(SEQ_MESSAGE_NO.NEXTVAL, #{messageContent}, DEFAULT, #{chattingRoomId}, DEFAULT, #{senderId})
	</insert>
	
	<select id="selectChattingRoom" resultMap="chattingRoom_rm">
		SELECT CHATTING_ROOM_ID, 
				TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS CREATED_AT, 
				ADMIN_MEMBER_NO,
				USER_MEMBER_NO
		FROM CHATTING_ROOM
		WHERE CHATTING_ROOM_ID = #{chattingRoomId}		
	</select>
	
</mapper>
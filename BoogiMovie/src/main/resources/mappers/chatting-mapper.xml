<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bm.project.chatting.model.dao.ChattingMapper">

	<resultMap type="com.bm.project.chatting.model.dto.ChattingRoom" id="chattingRoom_rm">
	     <id property="chattingNo" column="CHATTING_NO" />
	     <result property="lastMessage" column="LAST_MESSAGE" />
	     <result property="sendTime" column="SEND_TIME" />
	     <result property="targetNo" column="TARGET_NO" />
	     <result property="targetNickName" column="TARGET_NICKNAME" />
	     <result property="targetProfile" column="TARGET_PROFILE" />
	     <result property="notReadCount" column="NOT_READ_COUNT" />
	</resultMap>
	
	<resultMap type="com.bm.project.chatting.model.dto.Member_C" id="member_rm">
		<id property="memberNo" column="MEMBER_NO" />
		<result property="profilePath" column="PROFILE_IMG"/>
		<result property="memberEmail" column="MEMBER_EMAIL"/>
		<result property="memberNickname" column="MEMBER_NICKNAME"/>
	</resultMap>
	
	<resultMap type="com.bm.project.chatting.model.dto.ChattingMessage" id="message_rm">
	     <id property="messageId" column="MESSAGE_ID" />
	     <result property="messageContent" column="MESSAGE_CONTENT" />
	     <result property="sendAt" column="SENT_AT" />
	     <result property="chattingRoomId" column="CHATTING_ROOM_ID" />
	     <result property="readYn" column="READ_YN" />
	     <result property="senderId" column="SENDER_ID" />
	</resultMap>
	
	<resultMap type="com.bm.project.chatting.model.dto.ChattingImage" id="image_rm">
	     <id property="chattingImageNo" column="C_IMG_NO" />
	     <result property="messageId" column="MESSAGE_ID" />
	     <result property="chattingImagePath" column="C_IMG_PATH" />	     
	</resultMap>	

	<!-- 채팅방 목록 조회 -->
	<select id="selectRoomList" resultMap="chattingRoom_rm">
	    SELECT CHATTING_ROOM_ID AS CHATTING_NO,
	        -- 1) 가장 최근 메세지
	        (SELECT MESSAGE_CONTENT FROM (
	            SELECT M.* FROM CHATTING_MESSAGE M
	            WHERE M.CHATTING_ROOM_ID = R.CHATTING_ROOM_ID
	            ORDER BY MESSAGE_ID DESC) 
	            WHERE ROWNUM = 1
	        ) LAST_MESSAGE,
	            
	        -- 2) 채팅 보낸 시간
	        (SELECT TO_CHAR(MAX(CREATED_AT), 'YYYY.MM.DD') 
	         FROM CHATTING_MESSAGE M
	         WHERE CHATTING_ROOM_ID = R.CHATTING_ROOM_ID) SEND_TIME,
	        
	        -- 3) 타겟 회원 번호
	        CASE 
	            WHEN ADMIN_MEMBER_NO = #{memberNo} THEN USER_MEMBER_NO
	            ELSE ADMIN_MEMBER_NO
	        END AS TARGET_NO,
	        
	        -- 4) 타겟 회원 닉네임
	        (SELECT MEMBER_NICKNAME FROM MEMBER 
	         WHERE MEMBER_NO = (CASE WHEN ADMIN_MEMBER_NO = #{memberNo} THEN USER_MEMBER_NO ELSE ADMIN_MEMBER_NO END)
	        ) TARGET_NICKNAME,
	            
	        -- 5) 타겟 회원 프로필 이미지 (에러 방지를 위해 임시 NULL 처리)
	        NULL AS TARGET_PROFILE,
	        
	        -- 6) 읽지 않은 메세지 수 (SENDER_MEMBER_NO가 에러나면 SENDER_ID로 변경)
	        (SELECT COUNT(*) FROM CHATTING_MESSAGE M
	         WHERE READ_FL = 'N'
	         AND M.CHATTING_ROOM_ID = R.CHATTING_ROOM_ID
	         AND SENDER_ID != #{memberNo}) NOT_READ_COUNT,
	        
	        -- 7) 최근 메세지 번호
	        (SELECT MAX(MESSAGE_ID) FROM CHATTING_MESSAGE M
	         WHERE M.CHATTING_ROOM_ID = R.CHATTING_ROOM_ID) MAX_MESSAGE_NO
	    
	    FROM CHATTING_ROOM R
	    WHERE ADMIN_MEMBER_NO = #{memberNo}
	    OR USER_MEMBER_NO = #{memberNo}
	    
	    ORDER BY MAX_MESSAGE_NO DESC NULLS LAST
	</select>	
	<!-- 채팅 상대 조회 -->
	<select id="selectTarget" resultMap="member_rm">
		SELECT MEMBER_NO, PROFILE_IMG, MEMBER_NICKNAME, MEMBER_EMAIL
		FROM MEMBER
		WHERE (MEMBER_EMAIL LIKE '%${query}%' OR MEMBER_NICKNAME LIKE '%${query}%')
		AND MEMBER_DEL_FL = 'N'
		AND MEMBER_NO != ${memberNo}
	</select>
	
	<!-- 채팅방 입장(채팅방 존재 여부 확인)->(채팅방 번호 조회) -->
	<select id="checkChattingNo" resultType="_int">
		SELECT NVL(SUM(CHATTING_NO), 0) FROM CHATTING_ROOM
		WHERE (OPEN_MEMBER = ${targetNo} AND PARTICIPANT = ${loginMemberNo})
		OR (OPEN_MEMBER = ${loginMemberNo} AND PARTICIPANT = ${targetNo})
	</select>
	
	
	<!-- 채팅방 생성 -->
	<!-- 
		- useGeneratedKeys : DB 내부적으로 생성한 키(시퀀스)를 전달된 파라미터의 필드로 대입하겠다.(true) 
		- <selectKey> 속성 중 keyProperty : 전달된 파라미터에 어떻게 담을지 작성
										  -> 만약 DTO라면 필드명, Map이라면 Key 지정
		- order 속성 : 메인 sql이 수행되기 전/후에 selectKey가 수행되도록 지정 
		
		- select 수행 시 resultType/resultMap 작성 필수
		- DML(insert, delete, update)은 수행시 항상 int이기 때문에 resultType 작성 X
	
	-->
	<insert id="createChattingRoom" parameterType="map" useGeneratedKeys="true">
		<selectKey order="BEFORE" resultType="_int" keyProperty="chattingNo">
			SELECT SEQ_ROOM_NO.NEXTVAL FROM DUAL
		</selectKey>
	
		INSERT INTO CHATTING_ROOM
		VALUES(${chattingNo}, DEFAULT, ${loginMemberNo}, ${targetNo})
	</insert>
	
	<!-- 채팅 읽음 표시(업데이트) -->
	<update id="updateReadFlag">
		UPDATE MESSAGE SET
		READ_FL = 'Y'
		WHERE CHATTING_NO = ${chattingNo}
		AND SENDER_NO != ${memberNo}
	</update>
	
	<!-- 메세지 목록 조회 -->
	<select id="selectMessageList" resultMap="message_rm">
		SELECT MESSAGE_NO, MESSAGE_CONTENT, READ_FL, 
		    TO_CHAR(SEND_TIME, 'YYYY.MM.DD HH24:MI') SEND_TIME, SENDER_NO, CHATTING_NO
		FROM MESSAGE
		WHERE CHATTING_NO = ${chattingNo}
		ORDER BY MESSAGE_NO
	</select>
	
	<!-- 메세지 삽입 -->
	<insert id="insertMessage">
		INSERT INTO MESSAGE
		VALUES(SEQ_MESSAGE_NO.NEXTVAL, #{messageContent}, DEFAULT, DEFAULT, ${senderNo}, ${chattingNo})
	</insert>
	
	<!-- 채팅방 정보 가져오기 -->
	<select id="selectChattingRoom" resultMap="chattingRoom_rm">
		SELECT CHATTING_ROOM_ID, 
				TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS')AS CREATED_AT, 
				ADMIN_MEMBER_NO,
				USER_MEMBER_NO
		FROM CHATTING_ROOM
		WHERE CHATTING_ROOM_ID = #{chattingRoomId}		
		
	</select>
	
</mapper>
